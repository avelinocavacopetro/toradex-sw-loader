@page "/customization/{deviceId:int}/{productId:int}/{stackId:int}/{packageId}/{fleetId}/{boardUuid}"

@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject IJSRuntime JS
@inject IStringLocalizer<Resource> localizer
@inject IToastService ToastService
@inject NavigationManager UriHelper
@inject LoginService LoginService
@inject TorizonService TorizonService
@inject SweetAlertService Swal

<PageTitle>@localizer["CustomBoard"]</PageTitle>

@if (isLoading)
{
    <div class="center">
        <div class="text-center mt-5">
            <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">@localizer["Loading"]...</span>
            </div>
            <p class="mt-3">@localizer["Loading"]...</p>
        </div>
    </div>
} 
else
{
    <div class="custom-container d-flex flex-column">
        <a href="#"
            onclick="if (@(isLoading.ToString().ToLower())) { event.preventDefault(); } else { history.back(); }"
            class="text-black"
            style="max-width: 5vh; cursor: @(isLoading ? "default" : "pointer");">
            <i class="bi bi-arrow-left fs-1"></i>
        </a>

        <div class="page-wrapper">
            <div style="display:flex; justify-content:center;">
                <div class="text-center">
                    <table class="summary w-75" style="border-collapse: collapse;">
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">@localizer["Device"]</th>
                            <td style="border-bottom: 1px solid #ccc; padding: 12px; text-align: left;">@selectedDevice?.Name</td>
                        </tr>
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">@localizer["Product"]</th>
                            <td style="border-bottom: 1px solid #ccc; padding: 12px; text-align: left;">@selectedProduct?.Name</td>
                        </tr>
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">Stack</th>
                            <td style="border-bottom: 1px solid #ccc; padding: 12px; text-align: left;">@selectedStack?.Name</td>
                        </tr>
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">Software</th>
                            <td style="border-bottom: 1px solid #ccc; padding: 12px; text-align: left;">@selectedPackage?.Name @selectedPackage?.Version</td>
                        </tr>
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">@localizer["Fleet"]</th>
                            <td style="border-bottom: 1px solid #ccc; padding: 12px; text-align: left;">@selectedFleet?.Name</td>
                        </tr>
                        <tr>
                            <th style="background-color: #0c6527; color: white; padding: 12px; text-align: left;">@localizer["Board"]</th>
                            <td style="padding: 12px; text-align: left;">@selectedBoard?.DeviceName</td>
                        </tr>
                    </table>
                </div>
            </div>

            @if(!isEditing)
            {
                <div class="center-customization" style="min-height: 30vh;">
                    <h4 class="custom-label text-center px-5">
                        @finalBoard
                    <span class="bi bi-pencil-square px-5" aria-hidden="true" style="cursor:pointer" @onclick="ChangeName"></span>
                    </h4>
                </div>

                <div class="sticky-footer-center-buttons">
                    <button type="submit" class="btn btn-color btn-lg" style="width: 20vw; font-size: 1.5rem;" @onclick=ConfirmAndSubmit>OK</button>
                </div>
            }
            else
            {
                <div class="center-customization" style="min-height: 30vh;">
                    <h4 class="custom-label text-center px-5" style="white-space: nowrap;">
                        @finalBoard ( <input type="text" @bind="editableTag" class="form-control w-100 mx-auto" style="font-size: 1.2rem; text-align: center;" /> )
                    </h4>
                    <div class="sticky-footer-center-buttons">
                        <button class="btn btn-color mt-5 btn-lg btn-edit-custom" @onclick="SaveName">@localizer["Save"]</button>
                        <button class="btn btn-danger mt-5 ms-5 btn-lg btn-edit-custom" @onclick="CancelEdit">@localizer["Cancel"]</button>
                    </div>
                </div>
            }
        </div>
    </div>
}

@code {
    // Variáveis: Parameters
    [Parameter]
    public int deviceId { get; set; }

    [Parameter]
    public int productId { get; set; }

    [Parameter]
    public int stackId { get; set; }

    [Parameter]
    public string packageId { get; set; } = string.Empty;

    [Parameter]
    public string fleetId { get; set; } = string.Empty;

    [Parameter]
    public string boardUuid { get; set; } = string.Empty;

    // Variáveis: Object
    Device? selectedDevice = new();
    Product? selectedProduct = new();
    Stack? selectedStack = new ();
    Package? selectedPackage = new();
    Fleet? selectedFleet = new();
    DetailedDevice? selectedBoard = new();
    Package? packageUri = new();
    static readonly ILog _log = LogManager.GetLogger(typeof(CustomizationBoard));

    // Variáveis: String
    string originalFinalBoard = string.Empty;
    string finalBoard = string.Empty;
    string editableTag = string.Empty;
    string notEditable = string.Empty;
    string serialNumber = string.Empty;

    // Variáveis: Boolean
    bool isLoading = true;
    bool isEditing = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = DbContextFactory.CreateDbContext();
            selectedDevice = await context.Devices.FirstOrDefaultAsync(d => d.Id == deviceId);
            selectedProduct = await context.Products.FirstOrDefaultAsync(p => p.Id == productId);
            selectedStack = await context.Stacks.FirstOrDefaultAsync(s => s.Id == stackId);
            selectedPackage = await context.Packages.FirstOrDefaultAsync(p => p.Id == packageId);
            selectedFleet = await context.Fleets.FirstOrDefaultAsync(f => f.Id == fleetId);
            selectedProduct = await context.Products.FirstOrDefaultAsync(p => p.Id == productId);

            if (await TorizonService.AuthenticateAsync())
            {
                var boardUrl = $"https://app.torizon.io/api/v2beta/devices/{boardUuid}";
                selectedBoard = await TorizonService.GetItemAsync<DetailedDevice>(boardUrl);

                isLoading = false;
            }

            string[] parts = selectedBoard!.DeviceId.Split('-');
            serialNumber = parts[2];

            _log.Info("Customization page loaded successfully.");
        }
        catch (Exception ex)
        {
            _log.Error("Error loading Customization page.", ex);
        }
    }

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(finalBoard) && selectedDevice != null && selectedPackage != null && selectedFleet != null && selectedProduct != null)
        {
            notEditable = $"{selectedProduct.Name}_{serialNumber}";
            finalBoard = notEditable;
        }
    }

    void ChangeName()
    {
        try
        {
            isEditing = true;

            if (!string.IsNullOrEmpty(finalBoard) && !string.IsNullOrEmpty(notEditable) && finalBoard.StartsWith(notEditable))
            {
                var tag = finalBoard.Substring(notEditable.Length).Trim();

                if (tag.StartsWith("(") && tag.EndsWith(")"))
                {
                    editableTag = tag.Substring(1, tag.Length - 2);
                }
                else
                {
                    editableTag = tag;
                }
            }
            else
            {
                editableTag = string.Empty;
            }

            _log.Info("Name change successfully");
        }
        catch (Exception ex)
        {
            _log.Error("Failed to change name", ex);
        }
    }

    void SaveName()
    {
        isEditing = false;
        if(String.IsNullOrEmpty(editableTag))
        {
            finalBoard = $"{notEditable}".Trim();   
        } 
        else
        {
            finalBoard = $"{notEditable} ({editableTag})".Trim();
        }
    }

    void CancelEdit()
    {
        isEditing = false;
    }

    async Task ConfirmAndSubmit()
    {
        try
        {
            if (!string.IsNullOrEmpty(finalBoard) && finalBoard.Length > 100)
            {
                ToastService.ShowWarning(@localizer["LongName"]);
                return;
            }

            var result = await Swal.FireAsync(new SweetAlertOptions
            {
                Title = @localizer["WantContinue"],
                Icon = SweetAlertIcon.Warning,
                ShowCancelButton = true,
                ConfirmButtonText = @localizer["Continue"],
                ConfirmButtonColor = "#0B5120",
                CancelButtonText = @localizer["Cancel"],
                CancelButtonColor = "#dc3545"
            });

            if (result.IsConfirmed)
            {
                using var context = DbContextFactory.CreateDbContext();
                var userAct = new UserActivity
                {
                    UserId = LoginService.UserId,
                    ActMessage = $"Iniciou o carregamento da placa -> Nome: {finalBoard}",
                    ActType = "Wizard",
                    ActTimeStamp = DateTime.Now
                };

                var finalProduct = new FinalProduct
                {
                    DeviceUuid = selectedBoard!.DeviceUuid,
                    Name = finalBoard,
                    Status = selectedBoard.DeviceStatus,
                    CreatedAt = DateTime.Now,
                    LastSeen = selectedBoard.LastSeen,
                    DeviceId = deviceId,
                    ProductId = productId,
                    StackId = stackId,
                    PackageId = packageId,
                    FleetId = fleetId,
                    UserId = LoginService.UserId,
                    Enabled = true
                };

                var packageUri = await context.Packages.FirstOrDefaultAsync(p => p.Id == finalProduct.PackageId);

                var deviceDto = new DeviceDTO
                {
                    PackageIds = new List<string> { finalProduct.PackageId.ToString() },
                    Devices = new List<string> { finalProduct.DeviceUuid.ToString() },
                };

                var response = await TorizonService.SendUpdateAsync(deviceDto);

                if (response.IsSuccessStatusCode)
                {
                    context.UserActivities.Add(userAct);
                    context.FinalProducts.Add(finalProduct);
                    await context.SaveChangesAsync();

                    _log.Info($"Board '{selectedBoard?.DeviceName}' installed with software successfully.");

                    ToastService.ShowSuccess(@localizer["SuccessfulRequest"]);

                    UriHelper.NavigateTo("/home");
                }
                else
                {
                    ToastService.ShowWarning(@localizer["RequestError"]);

                    var errorContent = await response.Content.ReadAsStringAsync();

                    _log.Error($"Failed to update board '{selectedBoard?.DeviceName}'. StatusCode: {response.StatusCode}, Error: {errorContent}");
                }
            }
        }
        catch (Exception ex)
        {
            _log.Error("Error occurred while installing board software.", ex);
        }
    }

    public class JSResult
    {
        public bool IsConfirmed { get; set; }
    }
}