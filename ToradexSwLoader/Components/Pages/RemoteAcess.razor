@using log4net
@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject TorizonService TorizonService
@inject SweetAlertService Swal
@inject LoginService LoginService

<h6 class="pb-5">A sessão termina automaticamente após a duração selecionada. A duração predefinida é de 90 minutos e a sessão pode ser terminada manualmente a qualquer altura.</h6>

<h6>Duração da sessão de acesso (@FormatDuration(duration))</h6>

<div style="display: flex; align-items: center; flex-direction: column;">
    <input type="range"
           min="30"
           max="720"
           step="30"
           style="width: 470px; accent-color: #0078d7;"
           @bind="duration" />

    <div class="pt-1" style="display: flex; justify-content: space-between; width: 470px; font-size: 0.9rem; color: #666;">
        <p>30 min</p>
        <p>12 horas</p>
    </div>
</div>

<div class="text-center py-5">
    <button class="btn btn-color btn-lg" style="width: 20vw; font-size: 1.5rem;" @onclick="OnClick">Criar</button>
</div>

@code {
    // Parameters
    [Parameter]
    public string? DeviceUuid { get; set; }

    [Parameter]
    public SshKey? SelectedKey { get; set; }

    [Parameter]
    public EventCallback<SessionSsh> OnNextModal { get; set; }

    // Object Variables
    private DetailedDevice? selectedDevice = new();
    private Modal modalAcess = new();
    private static readonly ILog log = LogManager.GetLogger(typeof(RemoteAcess));

    // Integer Variables
    private int duration = 90;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var context = DbContextFactory.CreateDbContext();

            if (!await TorizonService.AuthenticateAsync())
            {
                log.Error("Error authenticating to Torizon Service.");
                return;
            }

            var detailUrl = $"https://app.torizon.io/api/v2beta/devices/{DeviceUuid}";
            selectedDevice = await TorizonService.GetItemAsync<DetailedDevice>(detailUrl);

            log.Info($"Device - {selectedDevice?.DeviceName} loaded successfully.");

            StateHasChanged();
        }
        catch (Exception ex)
        {
            log.Error("Error authenticating to Torizon Service or loading device.", ex);
        }
    }

    private string FormatDuration(int minutes)
    {
        int hours = minutes / 60;
        int remainingMinutes = minutes % 60;

        if (hours > 0 && remainingMinutes > 0)
            return $"{hours} hora{(hours > 1 ? "s" : "")} e {remainingMinutes} minuto{(remainingMinutes > 1 ? "s" : "")}";
        else if (hours > 0)
            return $"{hours} hora{(hours > 1 ? "s" : "")}";
        else
            return $"{remainingMinutes} minuto{(remainingMinutes > 1 ? "s" : "")}";
    }

    private async Task OnClick()
    {
        if (duration == 0)
        {
            log.Warn($"User {LoginService.UserId} attempted to create a session without selecting a duration.");
            await ShowWarningAsync("Selecione uma duração!");
            return;
        }

        var confirmed = await ConfirmAsync("Deseja continuar?");
        if (!confirmed)
        {
            log.Info($"User {LoginService.UserId} cancelled session creation.");
            return;
        }

        log.Info($"User {LoginService.UserId} initiated session creation for device {selectedDevice?.DeviceName} with duration {duration}.");

        var response = await TorizonService.SendCreateSession(DeviceUuid, duration, SelectedKey.Pubkey);

        if (response.IsSuccessStatusCode)
        {
            await HandleSessionCreatedAsync();
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
            log.Error($"Failed to create session for device {selectedDevice?.DeviceName} by user {LoginService.UserId}. Status: {response.StatusCode}, Response: {errorContent}");

            if ((int)response.StatusCode == 409)
            {
                var shouldCancel = await ConfirmAsync("Já existe uma sessão. Deseja apagar a sessão atual?", true);
                if (shouldCancel)
                {
                    log.Info($"User {LoginService.UserId} opted to cancel existing session for device {selectedDevice?.DeviceName}.");
                    await TorizonService.CancelSessionAsync(DeviceUuid);
                    await ShowSuccessAsync("Sessão removida com sucesso!");
                }
                else
                {
                    log.Info($"User {LoginService.UserId} declined to cancel existing session for device {selectedDevice?.DeviceName}.");
                }
            }
            else
            {
                await ShowErrorAsync($"Erro ao criar sessão: {response.StatusCode}");
            }
        }
    }

    private async Task<bool> ConfirmAsync(string message, bool showDeny = false)
    {
        var options = new SweetAlertOptions
        {
            Title = message,
            Icon = SweetAlertIcon.Warning,
            ShowCancelButton = !showDeny,
            ShowDenyButton = showDeny,
            ConfirmButtonText = "Continuar",
            ConfirmButtonColor = "#0B5120",
            CancelButtonText = showDeny ? "Não" : "Cancelar",
            DenyButtonText = showDeny ? "Não" : null
        };

        var result = await Swal.FireAsync(options);
        return result.IsConfirmed;
    }

    private async Task ShowWarningAsync(string message)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Title = message,
            Icon = SweetAlertIcon.Warning,
            ConfirmButtonColor = "#0B5120"
        });
    }

    private async Task ShowSuccessAsync(string message)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Title = message,
            Icon = SweetAlertIcon.Success,
            ConfirmButtonColor = "#0B5120"
        });
    }

    private async Task ShowErrorAsync(string message)
    {
        await Swal.FireAsync(new SweetAlertOptions
        {
            Title = "Erro",
            Text = message,
            Icon = SweetAlertIcon.Error,
            ConfirmButtonColor = "#0B5120"
        });
    }

    private async Task HandleSessionCreatedAsync()
    {
        log.Info($"Session successfully created for device {selectedDevice?.DeviceName} by user {LoginService.UserId}.");

        using var context = DbContextFactory.CreateDbContext();

        var userAct = new UserActivity
        {
            UserId = LoginService.UserId,
            ActMessage = $"Criou uma sessão para a placa {selectedDevice?.DeviceName} com duração {duration}",
            ActType = "Remote Access",
            ActTimeStamp = DateTime.Now
        };

        context.UserActivities.Add(userAct);
        await context.SaveChangesAsync();

        await ShowSuccessAsync("Sessão criada com sucesso!");
        await OnNextModal.InvokeAsync();
    }
}