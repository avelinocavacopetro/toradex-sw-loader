@page "/"
@using Microsoft.AspNetCore.Localization
@using log4net

@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject NavigationManager UriHelper
@inject LoginService LoginService
@inject IJSRuntime _jsRuntime
@inject IHttpContextAccessor HttpContextAccessor


<PageTitle>Log in</PageTitle>

<div class="d-flex flex-column custom-body">
    <div class="mx-auto position-relative title-container text-white pt-3">
        <h1 class="text-center">Toradex SW Loader</h1>
        <div class="secondary-title position-absolute pb-5" style="opacity:0.8;">
            <span style="font-size:17px;">Powered by</span>
            <img style="height:4vh;" src="images/linepetroteclogo.png" />
        </div>
    </div>

    <main class="flex-grow-1">
        <div class="d-flex justify-content-center pb-5">
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show w-25" role="alert">
                    @errorMessage
                    <button type="button" class="btn-close" aria-label="Close" @onclick="() => errorMessage = null"></button>
                </div>
            }
        </div>

        <div class="center-login pt-5">
            <div class="login-box position-relative shadow">
                <div class="user-icon-login shadow-sm">
                    <i class="bi bi-person-fill"></i>
                </div>

                <section class="mt-5">
                    <div class="form-floating mb-3 position-relative">
                        <input type="email" class="form-control pe-5" @bind="inputEmail" autocomplete="username" aria-required="true" placeholder="name@example.com" id="email" />
                        <label for="email" class="form-label">Utilizador</label>
                        <i class="bi bi-person-fill position-absolute top-50 end-0 translate-middle-y me-3"></i>
                    </div>

                    <div class="form-floating mb-3 position-relative">
                        <input type="password" class="form-control pe-5" @bind="inputPassword" autocomplete="current-password" aria-required="true" placeholder="password" id="password" />
                        <label for="password" class="form-label">Palavra-passe</label>
                        <i class="bi bi-lock-fill position-absolute top-50 end-0 translate-middle-y me-3"></i>
                    </div>
                    <br />
                    <div>
                        <a class="w-100 btn btn-custom btn-lg btn-primary" @onclick="RegisterLogin">Entrar</a>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer class="text-center pb-5">
        <div class="d-flex justify-content-between align-items-center w-100 px-4" style="color:white;">
            <span class="text-start" style="font-size: 15px; opacity:0.5;">v 2.0.0</span>
            <span style="font-size: 15px; opacity:0.5;">&copy; 2025 Petrotec</span>
            <a class="text-end" href="https://www.petrotec.com/" target="_blank">
                <img class="footer-logo" style="opacity:0.5;" src="images/petrotec_logo_white.png" />
            </a>
        </div>
    </footer>
</div>

<style>
    .custom-body {
        min-height: 96vh !important;
    }

    html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
    }

    .title-container {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
    }

    .secondary-title {
    right: 0;
    top: 100%;
    transform: translateX(5%);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    position: absolute;
}

    .footer-logo {
        height: 7vh;
        object-fit: contain;
    }

    .secondary-title img{
        filter: brightness(0) invert(1);
    }

    body {
        background-image: url("images/image-background-green.png");
        background-size:cover;
    }

    .login-box {
        background-color: #ffffff;
        padding: 4rem 2rem 3rem 2rem;
        border-radius: 10px;
        width: 100%;
        max-width: 400px;
        position: relative;
    }

    .btn-custom {
        background-color: #0B5120;
        color: white;
    }

        .btn-custom:hover {
            background-color: #073816;
            color: white;
        }
</style>

@code {
    // Object Variables
    private static readonly ILog log = LogManager.GetLogger(typeof(Login));

    // String Variables
    private string inputEmail = string.Empty;
    private string inputPassword = string.Empty;
    private string? errorMessage = string.Empty;
    private string? savedEmail;
    private string? savedPassword;
    private string? culture;

    // Boolean Variables
    private bool isLoading = true;
    private bool _autoLoginInProgress = false;

    private async Task RegisterLogin()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(inputEmail))
            { errorMessage = "O campo Email não pode estar vazio"; return; }

            if (string.IsNullOrWhiteSpace(inputPassword))
            { errorMessage = "O campo Password não pode estar vazio"; return; }

            if (!inputEmail.EndsWith("@petrotec.com"))
            { errorMessage = "O email inserido não é petrotec.com"; return; }

            using var context = DbContextFactory.CreateDbContext();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Email == inputEmail);

            if (user == null || user.Password != inputPassword)
            { errorMessage = "Email ou palavra-passe inválidos"; return; }

            var culture = new CultureInfo(user.Culture);
            var requestCulture = new RequestCulture(culture, culture);
            var cookieName = CookieRequestCultureProvider.DefaultCookieName;
            var cookieValue = CookieRequestCultureProvider.MakeCookieValue(requestCulture);
            await _jsRuntime.InvokeVoidAsync("setCookie", cookieName, cookieValue, 365);

            await _jsRuntime.InvokeVoidAsync("localStorage.setItem", "pendingAutoLogin", "1");
            await _jsRuntime.InvokeVoidAsync("localStorage.setItem", "loginEmail", inputEmail);
            await _jsRuntime.InvokeVoidAsync("localStorage.setItem", "loginPassword", inputPassword);

            await _jsRuntime.InvokeVoidAsync("eval", "location.reload()");
        }
        catch (Exception ex)
        {
            log.Error($"Error trying to login into {inputEmail}: ", ex);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _autoLoginInProgress) return;

        await _jsRuntime.InvokeVoidAsync("blazorLog", "OnAfterRenderAsync firstRender");

        var pending = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "pendingAutoLogin");
        if (pending == "1")
        {
            _autoLoginInProgress = true;

            var savedEmail = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "loginEmail");
            var savedPassword = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "loginPassword");

            await _jsRuntime.InvokeVoidAsync("localStorage.removeItem", "pendingAutoLogin");
            await _jsRuntime.InvokeVoidAsync("localStorage.removeItem", "loginEmail");
            await _jsRuntime.InvokeVoidAsync("localStorage.removeItem", "loginPassword");

            if (!string.IsNullOrEmpty(savedEmail) && !string.IsNullOrEmpty(savedPassword))
            {
                await CompleteLoginAfterReload(savedEmail, savedPassword);
            }
        }
    }

    private async Task CompleteLoginAfterReload(string email, string password)
    {
        try
        {
            using var context = DbContextFactory.CreateDbContext();
            var user = await context.Users.FirstOrDefaultAsync(u => u.Email == email);

            if (user == null || user.Password != password)
            {
                errorMessage = "Email ou palavra-passe inválidos";
                StateHasChanged();
                return;
            }

            LoginService.SetLogin(user.Id, user.UserName, user.Culture);

            var loginLog = new LoginLog
            {
                UserId = user.Id,
                Email = email,
                LoginTimeStamp = DateTime.Now
            };
            context.LoginLogs.Add(loginLog);
            await context.SaveChangesAsync();

            UriHelper.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            log.Error($"Auto-login after reload failed for {email}: ", ex);
        }
    }
}